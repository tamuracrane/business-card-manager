<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂêçÂà∫ÁÆ°ÁêÜ„Ç¢„Éó„É™ (Claude APIÁâà)</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .login-container h2 {
            color: #667eea;
            margin-bottom: 30px;
        }

        .login-container p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9ff;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-details {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            color: #333;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            background: #f8f9ff;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #999;
            font-size: 14px;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
            font-size: 18px;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 10px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-logout {
            background: #ff4757;
            color: white;
        }

        .btn-logout:hover {
            background: #ff3838;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .image-upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .image-upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .image-info {
            margin-top: 10px;
            font-size: 14px;
            color: #999;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #e0e0e0;
        }

        .card-info h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .card-info p {
            color: #555;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #999;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3838;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        #ocrProgress, #compressionProgress {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        #ocrProgress {
            background: #e3f2fd;
        }

        .progress-status {
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .ocr-result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .ocr-result h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .ocr-result pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }

        .extraction-status {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .extraction-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: white;
            border-radius: 5px;
            font-size: 13px;
        }

        .extraction-item.found {
            color: #4CAF50;
        }

        .extraction-item.not-found {
            color: #999;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 999;
        }

        .sync-status.syncing {
            background: #2196F3;
        }

        .sync-status.error {
            background: #ff4757;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        .quality-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            font-size: 12px;
            color: #856404;
        }

        .api-key-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .api-key-notice-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .api-key-notice-content {
            flex: 1;
        }

        .api-key-notice h4 {
            color: #856404;
            margin-bottom: 8px;
        }

        .api-key-notice p {
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-key-input input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ffc107;
            border-radius: 5px;
            font-size: 14px;
        }

        .api-key-input button {
            padding: 8px 16px;
            background: #ffc107;
            border: none;
            border-radius: 5px;
            color: #856404;
            font-weight: bold;
            cursor: pointer;
        }

        .api-key-input button:hover {
            background: #ffb300;
        }

        .api-key-saved {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 10px;
            border-radius: 5px;
            color: #155724;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginContainer" class="login-container">
        <h2>üóÇÔ∏è ÂêçÂà∫ÁÆ°ÁêÜ„Ç¢„Éó„É™</h2>
        <p>Claude APIÁâà - AIÊê≠Ëºâ„ÅÆË∂ÖÈ´òÁ≤æÂ∫¶OCR<br>Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
        <button class="btn btn-primary" onclick="loginWithGoogle()">
            üîê Google„Åß„É≠„Ç∞„Ç§„É≥
        </button>
        <p style="margin-top: 20px; font-size: 14px; color: #999;">
            ‚ú® Ê∞èÂêç„Éª‰ºöÁ§æ„ÉªÈõªË©±„Éª„É°„Éº„É´„ÇíÈ´òÁ≤æÂ∫¶„ÅßËá™ÂãïÂÖ•Âäõ
        </p>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ÁîªÈù¢ -->
    <div id="appContainer" class="container hidden">
        <h1>üóÇÔ∏è ÂêçÂà∫ÁÆ°ÁêÜ„Ç¢„Éó„É™ <span class="quality-badge">Claude APIÁâà</span></h1>
        
        <!-- API KeyË®≠ÂÆö„Ç®„É™„Ç¢ -->
        <div id="apiKeyNotice" class="api-key-notice">
            <div class="api-key-notice-icon">üîë</div>
            <div class="api-key-notice-content">
                <h4>Claude API „Ç≠„Éº„ÅÆË®≠ÂÆö</h4>
                <p>È´òÁ≤æÂ∫¶OCR„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅClaude API„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ<br>
                ÂèñÂæóÊñπÊ≥ï: <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a> „Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶ÁÑ°Êñô„ÅßAPI„Ç≠„Éº„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <div class="api-key-input">
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-xxxxxxxxxx">
                    <button onclick="saveApiKey()">‰øùÂ≠ò</button>
                </div>
                <div id="apiKeySaved" class="api-key-saved">
                    ‚úÖ API„Ç≠„Éº„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ
                </div>
            </div>
        </div>
        
        <div class="user-info">
            <div class="user-details">
                <img id="userPhoto" src="" alt="User">
                <span class="user-name" id="userName"></span>
            </div>
            <button class="btn btn-logout btn-small" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">Á∑èÂêçÂà∫Êï∞:</span>
                <span class="stat-value" id="totalCards">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ë°®Á§∫‰∏≠:</span>
                <span class="stat-value" id="displayedCards">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">„Çπ„Éà„É¨„Éº„Ç∏‰ΩøÁî®Èáè:</span>
                <span class="stat-value" id="storageUsed">0 MB</span>
            </div>
        </div>

        <input type="text" 
               id="searchInput" 
               class="search-box" 
               placeholder="üîç Ê∞èÂêç„ÄÅ‰ºöÁ§æÂêç„ÄÅÈõªË©±Áï™Âè∑„ÄÅ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÄÅ„É°„É¢„Å™„Å©„ÅßÊ§úÁ¥¢...">
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="openModal()">‚ûï Êñ∞Ë¶èÂêçÂà∫ËøΩÂä†</button>
            <button class="btn btn-secondary" onclick="exportData()">üíæ „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        </div>

        <div id="cardsContainer" class="cards-grid">
            <div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>

        <div id="pagination" class="pagination hidden">
            <button onclick="loadPreviousPage()" id="prevBtn">‚Üê Ââç„Å∏</button>
            <span id="pageInfo">1 / 1</span>
            <button onclick="loadNextPage()" id="nextBtn">Ê¨°„Å∏ ‚Üí</button>
        </div>
    </div>

    <!-- ÂêçÂà∫ËøΩÂä†/Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Êñ∞Ë¶èÂêçÂà∫ËøΩÂä†</h2>
            
            <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
                <p>üì∑ „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂêçÂà∫ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</p>
                <p style="font-size: 14px; color: #999;">Claude AI„ÅåËá™Âãï„ÅßÊÉÖÂ†±„ÇíÊäΩÂá∫„Åó„Åæ„Åô</p>
                <input type="file" 
                       id="imageInput" 
                       accept="image/*" 
                       style="display: none;" 
                       onchange="handleImageUpload(event)">
                <img id="imagePreview" class="image-preview" style="display: none;">
                <div id="imageInfo" class="image-info"></div>
            </div>

            <div id="compressionProgress">
                <div class="progress-status">üì¶ ÁîªÂÉè„ÇíÂúßÁ∏Æ‰∏≠...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="compressionFill" style="width: 0%"></div>
                </div>
            </div>

            <div id="ocrProgress">
                <div class="progress-status" id="ocrStatus">üîç AIËß£Êûê‰∏≠...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="extraction-status" id="extractionStatus"></div>
                <div id="debugInfo" class="debug-info" style="display: none;"></div>
            </div>

            <div id="ocrResult" class="ocr-result" style="display: none;">
                <h4>üìÑ AIÊäΩÂá∫ÁµêÊûú</h4>
                <pre id="ocrText"></pre>
            </div>

            <form id="cardForm" onsubmit="saveCard(event)">
                <input type="hidden" id="cardId">
                
                <div class="form-group">
                    <label for="name">Ê∞èÂêç *</label>
                    <input type="text" id="name" required placeholder="Â±±Áî∞ Â§™ÈÉé">
                </div>

                <div class="form-group">
                    <label for="company">‰ºöÁ§æÂêç</label>
                    <input type="text" id="company" placeholder="Ê†™Âºè‰ºöÁ§æ„Çµ„É≥„Éó„É´">
                </div>

                <div class="form-group">
                    <label for="position">ÂΩπËÅ∑</label>
                    <input type="text" id="position" placeholder="Âñ∂Ê•≠ÈÉ®Èï∑">
                </div>

                <div class="form-group">
                    <label for="email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="email" placeholder="yamada@example.com">
                </div>

                <div class="form-group">
                    <label for="phone">ÈõªË©±Áï™Âè∑</label>
                    <input type="tel" id="phone" placeholder="03-1234-5678">
                </div>

                <div class="form-group">
                    <label for="address">‰ΩèÊâÄ</label>
                    <input type="text" id="address" placeholder="Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫...">
                </div>

                <div class="form-group">
                    <label for="memo">„É°„É¢</label>
                    <textarea id="memo" placeholder="„É°„É¢„ÇíÂÖ•Âäõ..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">‰øùÂ≠ò</button>
            </form>
        </div>
    </div>

    <!-- ÂêåÊúü„Çπ„ÉÜ„Éº„Çø„Çπ -->
    <div id="syncStatus" class="sync-status">
        <div class="spinner"></div>
        <span id="syncText">ÂêåÊúü‰∏≠...</span>
    </div>

    <script>
        // ========================================
        // FirebaseË®≠ÂÆö(„Åì„Åì„Å´Ëá™ÂàÜ„ÅÆË®≠ÂÆö„ÇíÂÖ•„Çå„Çã)
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBrnz0pOgHv7bCAhaVmM9kovRBMQI54yLU",
            authDomain: "meishi-kanri-d6920.firebaseapp.com",
            projectId: "meishi-kanri-d6920",
            storageBucket: "meishi-kanri-d6920.firebasestorage.app",
            messagingSenderId: "702234993651",
            appId: "1:702234993651:web:2332fb8f6905ed81892886",
            measurementId: "G-0HK7C4GGZP"
        };

        // FirebaseÂàùÊúüÂåñ
        let app, auth, db, storage;
        let currentUser = null;
        let businessCards = [];
        let currentEditId = null;
        let unsubscribe = null;

        // Claude API„Ç≠„Éº
        let claudeApiKey = localStorage.getItem('claudeApiKey') || '';

        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
        const CARDS_PER_PAGE = 50;
        let currentPage = 1;
        let totalPages = 1;
        let filteredCards = [];

        // ÁîªÂÉèÂúßÁ∏ÆË®≠ÂÆö
        const MAX_IMAGE_SIZE = 50 * 1024;
        const THUMBNAIL_MAX_SIZE = 10 * 1024;
        const MAX_WIDTH = 800;
        const MAX_HEIGHT = 800;
        const THUMBNAIL_WIDTH = 300;
        const THUMBNAIL_HEIGHT = 300;

        // ÂàùÊúüÂåñÈñ¢Êï∞
        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                console.log('Firebase initialized successfully');
                
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        showApp();
                        loadCardsFromFirestore();
                        checkApiKey();
                    } else {
                        currentUser = null;
                        showLogin();
                    }
                });
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('FirebaseË®≠ÂÆö„Ç®„É©„Éº: ' + error.message + '\n\nHTML„Éï„Ç°„Ç§„É´„ÅÆfirebaseConfig„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ „Ç¢„Éó„É™Ëµ∑Âãï');
            
            initializeFirebase();
            
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    filterAndDisplayCards(e.target.value);
                }, 300);
            });
        });

        // ========================================
        // API„Ç≠„ÉºÁÆ°ÁêÜ
        // ========================================

        function checkApiKey() {
            if (claudeApiKey) {
                document.getElementById('apiKeyInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                document.getElementById('apiKeySaved').style.display = 'block';
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (!key) {
                alert('API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (!key.startsWith('sk-ant-')) {
                alert('ÁÑ°Âäπ„Å™API„Ç≠„Éº„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑAPI„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            claudeApiKey = key;
            localStorage.setItem('claudeApiKey', key);
            
            input.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            document.getElementById('apiKeySaved').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('apiKeySaved').style.display = 'none';
            }, 3000);
        }

        // ========================================
        // ÁîªÂÉèÂúßÁ∏ÆÈñ¢ÈÄ£
        // ========================================

        async function compressImage(file, maxSize, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.9;
                        
                        const tryCompress = () => {
                            canvas.toBlob((b) => {
                                if (b.size <= maxSize || quality <= 0.1) {
                                    resolve(b);
                                } else {
                                    quality -= 0.1;
                                    tryCompress();
                                }
                            }, 'image/jpeg', quality);
                        };
                        
                        tryCompress();
                    };
                    
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function blobToDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // ========================================
        // Ë™çË®ºÈñ¢ÈÄ£
        // ========================================
        
        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showSyncStatus('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('Login error:', error);
                alert('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: ' + error.message);
            }
        }

        async function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„Åã?')) {
                try {
                    if (unsubscribe) {
                        unsubscribe();
                    }
                    await auth.signOut();
                    showSyncStatus('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº: ' + error.message);
                }
            }
        }

        function showLogin() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('userPhoto').src = currentUser.photoURL || 'https://via.placeholder.com/40';
            }
        }

        // ========================================
        // Firestore „Éá„Éº„ÇøÊìç‰Ωú
        // ========================================

        function loadCardsFromFirestore() {
            showSyncStatus('„Éá„Éº„Çø„ÇíÂêåÊúü‰∏≠...', 'syncing');
            
            unsubscribe = db.collection('businessCards')
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    businessCards = [];
                    let totalSize = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        businessCards.push({
                            id: doc.id,
                            ...data
                        });
                        
                        if (data.thumbnailUrl) {
                            totalSize += THUMBNAIL_MAX_SIZE / 1024 / 1024;
                        }
                    });
                    
                    document.getElementById('totalCards').textContent = businessCards.length;
                    document.getElementById('storageUsed').textContent = totalSize.toFixed(2) + ' MB';
                    
                    currentPage = 1;
                    filterAndDisplayCards();
                    showSyncStatus('ÂêåÊúüÂÆå‰∫Ü', 'success');
                }, error => {
                    console.error('Firestore error:', error);
                    showSyncStatus('ÂêåÊúü„Ç®„É©„Éº', 'error');
                });
        }

        // ========================================
        // „É¢„Éº„ÉÄ„É´Êìç‰Ωú
        // ========================================

        function openModal(cardId = null) {
            document.getElementById('cardModal').classList.add('active');
            document.getElementById('cardForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageInfo').textContent = '';
            document.getElementById('ocrResult').style.display = 'none';
            document.getElementById('ocrProgress').style.display = 'none';
            document.getElementById('debugInfo').style.display = 'none';
            
            if (cardId) {
                currentEditId = cardId;
                document.getElementById('modalTitle').textContent = 'ÂêçÂà∫Á∑®ÈõÜ';
                const card = businessCards.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('cardId').value = card.id;
                    document.getElementById('name').value = card.name || '';
                    document.getElementById('company').value = card.company || '';
                    document.getElementById('position').value = card.position || '';
                    document.getElementById('email').value = card.email || '';
                    document.getElementById('phone').value = card.phone || '';
                    document.getElementById('address').value = card.address || '';
                    document.getElementById('memo').value = card.memo || '';
                    
                    if (card.imageUrl) {
                        document.getElementById('imagePreview').src = card.imageUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                    }
                }
            } else {
                currentEditId = null;
                document.getElementById('modalTitle').textContent = 'Êñ∞Ë¶èÂêçÂà∫ËøΩÂä†';
            }
        }

        function closeModal() {
            document.getElementById('cardModal').classList.remove('active');
            currentEditId = null;
            uploadedImageBlob = null;
            uploadedThumbnailBlob = null;
        }

        // ========================================
        // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ & Claude API OCR
        // ========================================

        let uploadedImageBlob = null;
        let uploadedThumbnailBlob = null;

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üì∏ ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÈñãÂßã:', file.name, formatFileSize(file.size));

            const compressionProgress = document.getElementById('compressionProgress');
            const compressionFill = document.getElementById('compressionFill');
            const imageInfo = document.getElementById('imageInfo');
            
            try {
                const originalSize = formatFileSize(file.size);
                imageInfo.textContent = `ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫: ${originalSize}`;
                compressionProgress.style.display = 'block';
                compressionFill.style.width = '30%';

                uploadedImageBlob = await compressImage(file, MAX_IMAGE_SIZE, MAX_WIDTH, MAX_HEIGHT);
                compressionFill.style.width = '60%';

                uploadedThumbnailBlob = await compressImage(file, THUMBNAIL_MAX_SIZE, THUMBNAIL_WIDTH, THUMBNAIL_HEIGHT);
                compressionFill.style.width = '100%';

                const compressedSize = formatFileSize(uploadedImageBlob.size);
                const thumbnailSize = formatFileSize(uploadedThumbnailBlob.size);
                
                imageInfo.innerHTML = `
                    ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫: ${originalSize}<br>
                    ÂúßÁ∏ÆÂæå: ${compressedSize} (ÁîªÂÉè) + ${thumbnailSize} („Çµ„É†„Éç„Ç§„É´)<br>
                    <span style="color: #4CAF50;">‚úÖ ÂúßÁ∏ÆÂÆå‰∫Ü</span>
                `;

                const dataUrl = await blobToDataURL(uploadedImageBlob);
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = dataUrl;
                imagePreview.style.display = 'block';

                console.log('‚úÖ ÁîªÂÉèÂúßÁ∏ÆÂÆå‰∫Ü');

                setTimeout(() => {
                    compressionProgress.style.display = 'none';
                }, 1000);

                // Claude API OCRÂá¶ÁêÜÈñãÂßã
                console.log('üîç Claude API OCRÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô...');
                await performClaudeOCR(dataUrl);
            } catch (error) {
                console.error('‚ùå ÂúßÁ∏Æ„Ç®„É©„Éº:', error);
                compressionProgress.style.display = 'none';
                imageInfo.innerHTML = '<span style="color: #ff4757;">‚ö†Ô∏è ÂúßÁ∏Æ„Ç®„É©„Éº</span>';
                alert('ÁîªÂÉè„ÅÆÂúßÁ∏Æ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        /**
         * Claude API „Çí‰ΩøÁî®„Åó„ÅüÈ´òÁ≤æÂ∫¶OCRÂá¶ÁêÜ
         */
        async function performClaudeOCR(imageSrc) {
            if (!claudeApiKey) {
                alert('Claude API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁîªÈù¢‰∏äÈÉ®„ÅßAPI„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const progressDiv = document.getElementById('ocrProgress');
            const progressFill = document.getElementById('progressFill');
            const ocrStatus = document.getElementById('ocrStatus');
            const extractionStatus = document.getElementById('extractionStatus');
            const ocrResult = document.getElementById('ocrResult');
            const ocrText = document.getElementById('ocrText');
            const debugInfo = document.getElementById('debugInfo');
            
            progressDiv.style.display = 'block';
            extractionStatus.innerHTML = '';
            debugInfo.style.display = 'block';
            debugInfo.textContent = 'ü§ñ Claude AI„Å´Êé•Á∂ö‰∏≠...';

            try {
                ocrStatus.textContent = 'üîç Claude AI„ÅßÁîªÂÉè„ÇíËß£Êûê‰∏≠...';
                progressFill.style.width = '20%';

                // Base64„Éá„Éº„Çø„ÇíÊäΩÂá∫
                const base64Data = imageSrc.split(',')[1];
                
                debugInfo.textContent = 'üì§ ÁîªÂÉè„Éá„Éº„Çø„ÇíÈÄÅ‰ø°‰∏≠...';
                progressFill.style.width = '40%';

                // Claude API„É™„ÇØ„Ç®„Çπ„Éà
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': claudeApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: 'image/jpeg',
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `„Åì„ÅÆÁîªÂÉè„ÅØÂêçÂà∫„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÇíÊäΩÂá∫„Åó„Å¶JSONÂΩ¢Âºè„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠óÂàó„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂøÖÈ†à„Éï„Ç©„Éº„Éû„ÉÉ„Éà:
{
  "name": "Ê∞èÂêçÔºà„Éï„É´„Éç„Éº„É†Ôºâ",
  "company": "‰ºöÁ§æÂêç",
  "position": "ÂΩπËÅ∑",
  "email": "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ",
  "phone": "ÈõªË©±Áï™Âè∑",
  "address": "‰ΩèÊâÄ"
}

ÈáçË¶Å„Å™Ê≥®ÊÑèÁÇπ:
- JSON„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË™¨ÊòéÊñá„ÅØ‰∏çË¶ÅÔºâ
- Ê∞èÂêç„ÅØÂßì„Å®Âêç„ÅÆÈñì„Å´„Çπ„Éö„Éº„Çπ„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ
- ÈõªË©±Áï™Âè∑„ÅØ„Éè„Ç§„Éï„É≥Âå∫Âàá„Çä„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æã: 03-1234-5678Ôºâ
- Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÈ†ÖÁõÆ„ÅØÁ©∫ÊñáÂ≠óÂàó""„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ`
                                }
                            ]
                        }]
                    })
                });

                progressFill.style.width = '70%';
                debugInfo.textContent = 'üîÑ AIÂøúÁ≠î„ÇíÂá¶ÁêÜ‰∏≠...';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                progressFill.style.width = '90%';
                
                console.log('=== Claude API Response ===');
                console.log(data);

                // „É¨„Çπ„Éù„É≥„Çπ„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫
                let extractedText = '';
                if (data.content && Array.isArray(data.content)) {
                    extractedText = data.content
                        .filter(block => block.type === 'text')
                        .map(block => block.text)
                        .join('\n');
                }

                console.log('Extracted Text:', extractedText);

                // JSON„Çí„Éë„Éº„Çπ
                let parsedData = null;
                try {
                    // ```json ``` „Å™„Å©„ÅÆ„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂâäÈô§
                    const cleanedText = extractedText
                        .replace(/```json\n?/g, '')
                        .replace(/```\n?/g, '')
                        .trim();
                    
                    parsedData = JSON.parse(cleanedText);
                    console.log('Parsed Data:', parsedData);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    throw new Error('AIÂøúÁ≠î„ÅÆJSONËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                progressFill.style.width = '100%';
                debugInfo.textContent = '‚úÖ AIËß£ÊûêÂÆå‰∫ÜÔºÅ';

                // OCRÁµêÊûú„ÇíË°®Á§∫
                ocrResult.style.display = 'block';
                ocrText.textContent = JSON.stringify(parsedData, null, 2);

                // „Éï„Ç£„Éº„É´„Éâ„Å´Ëá™ÂãïÂÖ•Âäõ
                const result = {
                    name: parsedData.name || '',
                    company: parsedData.company || '',
                    position: parsedData.position || '',
                    email: parsedData.email || '',
                    phone: parsedData.phone || '',
                    address: parsedData.address || ''
                };

                // ÊäΩÂá∫Áä∂ÊÖã„ÇíË°®Á§∫
                const statuses = [
                    { label: 'Ê∞èÂêç', found: result.name !== '' },
                    { label: '‰ºöÁ§æÂêç', found: result.company !== '' },
                    { label: 'ÂΩπËÅ∑', found: result.position !== '' },
                    { label: '„É°„Éº„É´', found: result.email !== '' },
                    { label: 'ÈõªË©±', found: result.phone !== '' },
                    { label: '‰ΩèÊâÄ', found: result.address !== '' }
                ];
                
                extractionStatus.innerHTML = statuses.map(s => `
                    <div class="extraction-item ${s.found ? 'found' : 'not-found'}">
                        ${s.found ? '‚úÖ' : '‚ö™'} ${s.label}
                    </div>
                `).join('');
                
                const foundCount = statuses.filter(s => s.found).length;
                ocrStatus.textContent = `‚úÖ AIËß£ÊûêÂÆå‰∫Ü! (${foundCount}/6È†ÖÁõÆ„ÇíÊ§úÂá∫)`;

                // „Éï„Ç©„Éº„É†„Å´Ëá™ÂãïÂÖ•Âäõ
                if (result.name && !document.getElementById('name').value) {
                    document.getElementById('name').value = result.name;
                }
                if (result.company && !document.getElementById('company').value) {
                    document.getElementById('company').value = result.company;
                }
                if (result.position && !document.getElementById('position').value) {
                    document.getElementById('position').value = result.position;
                }
                if (result.email && !document.getElementById('email').value) {
                    document.getElementById('email').value = result.email;
                }
                if (result.phone && !document.getElementById('phone').value) {
                    document.getElementById('phone').value = result.phone;
                }
                if (result.address && !document.getElementById('address').value) {
                    document.getElementById('address').value = result.address;
                }

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 3000);
                
                showSyncStatus('AIËß£ÊûêÂÆå‰∫Ü', 'success');
            } catch (error) {
                console.error('‚ùå Claude API Error:', error);
                progressDiv.style.display = 'block';
                ocrStatus.textContent = '‚ö†Ô∏è AIËß£ÊûêÂ§±Êïó';
                debugInfo.style.display = 'block';
                debugInfo.textContent = `‚ùå „Ç®„É©„Éº: ${error.message}`;
                showSyncStatus('AIËß£ÊûêÂ§±Êïó', 'error');
                
                alert('AIËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:\n' + error.message + '\n\nAPI„Ç≠„Éº„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // ========================================
        // ÂêçÂà∫‰øùÂ≠ò
        // ========================================

        async function saveCard(event) {
            event.preventDefault();
            showSyncStatus('‰øùÂ≠ò‰∏≠...', 'syncing');

            try {
                let imageUrl = null;
                let thumbnailUrl = null;

                if (uploadedImageBlob && uploadedThumbnailBlob) {
                    const timestamp = Date.now();
                    
                    const imageFileName = `cards/${timestamp}_full.jpg`;
                    const imageRef = storage.ref(imageFileName);
                    await imageRef.put(uploadedImageBlob);
                    imageUrl = await imageRef.getDownloadURL();
                    
                    const thumbnailFileName = `cards/${timestamp}_thumb.jpg`;
                    const thumbnailRef = storage.ref(thumbnailFileName);
                    await thumbnailRef.put(uploadedThumbnailBlob);
                    thumbnailUrl = await thumbnailRef.getDownloadURL();
                } else if (currentEditId) {
                    const card = businessCards.find(c => c.id === currentEditId);
                    imageUrl = card ? card.imageUrl : null;
                    thumbnailUrl = card ? card.thumbnailUrl : null;
                }

                const cardData = {
                    name: document.getElementById('name').value,
                    company: document.getElementById('company').value,
                    position: document.getElementById('position').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    memo: document.getElementById('memo').value,
                    imageUrl: imageUrl,
                    thumbnailUrl: thumbnailUrl,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.displayName || currentUser.email
                };

                if (currentEditId) {
                    await db.collection('businessCards').doc(currentEditId).update(cardData);
                } else {
                    cardData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    cardData.createdBy = currentUser.displayName || currentUser.email;
                    await db.collection('businessCards').add(cardData);
                }

                uploadedImageBlob = null;
                uploadedThumbnailBlob = null;
                closeModal();
                showSyncStatus('‰øùÂ≠òÂÆå‰∫Ü', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showSyncStatus('‰øùÂ≠ò„Ç®„É©„Éº', 'error');
                alert('‰øùÂ≠ò„Ç®„É©„Éº: ' + error.message);
            }
        }

        // ========================================
        // ÂêçÂà∫Ë°®Á§∫(„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥‰ªò„Åç)
        // ========================================

        function filterAndDisplayCards(searchTerm = '') {
            filteredCards = businessCards;
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredCards = businessCards.filter(card => {
                    return (
                        (card.name && card.name.toLowerCase().includes(term)) ||
                        (card.company && card.company.toLowerCase().includes(term)) ||
                        (card.position && card.position.toLowerCase().includes(term)) ||
                        (card.email && card.email.toLowerCase().includes(term)) ||
                        (card.phone && card.phone.toLowerCase().includes(term)) ||
                        (card.address && card.address.toLowerCase().includes(term)) ||
                        (card.memo && card.memo.toLowerCase().includes(term))
                    );
                });
            }

            totalPages = Math.ceil(filteredCards.length / CARDS_PER_PAGE);
            displayCurrentPage();
        }

        function displayCurrentPage() {
            const container = document.getElementById('cardsContainer');
            const pagination = document.getElementById('pagination');
            
            document.getElementById('displayedCards').textContent = filteredCards.length;
            
            if (filteredCards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="4" width="18" height="16" rx="2" stroke-width="2"/>
                            <path d="M3 10h18M9 4v6" stroke-width="2"/>
                        </svg>
                        <h3>${document.getElementById('searchInput').value ? 'Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : '„Åæ„Å†ÂêçÂà∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}</h3>
                        <p>${document.getElementById('searchInput').value ? 'Âà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ' : '„ÄåÊñ∞Ë¶èÂêçÂà∫ËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÂêçÂà∫„ÇíÁôªÈå≤„Åó„Åæ„Åó„Çá„ÅÜ'}</p>
                    </div>
                `;
                pagination.classList.add('hidden');
                return;
            }

            const startIndex = (currentPage - 1) * CARDS_PER_PAGE;
            const endIndex = Math.min(startIndex + CARDS_PER_PAGE, filteredCards.length);
            const pageCards = filteredCards.slice(startIndex, endIndex);

            container.innerHTML = pageCards.map(card => `
                <div class="card" onclick="openModal('${card.id}')">
                    ${card.thumbnailUrl ? `<img src="${card.thumbnailUrl}" alt="${card.name}" class="card-image" loading="lazy">` : '<div class="card-image"></div>'}
                    <div class="card-info">
                        <h3>${card.name}</h3>
                        ${card.company ? `<p>üè¢ ${card.company}</p>` : ''}
                        ${card.position ? `<p>üíº ${card.position}</p>` : ''}
                        ${card.email ? `<p>üìß ${card.email}</p>` : ''}
                        ${card.phone ? `<p>üìû ${card.phone}</p>` : ''}
                        ${card.memo ? `<p>üìù ${card.memo.substring(0, 50)}${card.memo.length > 50 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="card-footer">
                        <span>ÁôªÈå≤: ${card.createdBy || '‰∏çÊòé'}</span>
                        <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteCard('${card.id}')">ÂâäÈô§</button>
                    </div>
                </div>
            `).join('');

            if (totalPages > 1) {
                pagination.classList.remove('hidden');
                document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
                document.getElementById('prevBtn').disabled = currentPage === 1;
                document.getElementById('nextBtn').disabled = currentPage === totalPages;
            } else {
                pagination.classList.add('hidden');
            }
        }

        function loadNextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPage();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function loadPreviousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ========================================
        // ÂêçÂà∫ÂâäÈô§
        // ========================================

        async function deleteCard(cardId) {
            if (confirm('„Åì„ÅÆÂêçÂà∫„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„Åã?')) {
                showSyncStatus('ÂâäÈô§‰∏≠...', 'syncing');
                try {
                    const card = businessCards.find(c => c.id === cardId);
                    
                    if (card) {
                        if (card.imageUrl) {
                            const imageRef = storage.refFromURL(card.imageUrl);
                            await imageRef.delete().catch(err => console.log('Image delete error:', err));
                        }
                        if (card.thumbnailUrl) {
                            const thumbnailRef = storage.refFromURL(card.thumbnailUrl);
                            await thumbnailRef.delete().catch(err => console.log('Thumbnail delete error:', err));
                        }
                    }
                    
                    await db.collection('businessCards').doc(cardId).delete();
                    showSyncStatus('ÂâäÈô§ÂÆå‰∫Ü', 'success');
                } catch (error) {
                    console.error('Delete error:', error);
                    showSyncStatus('ÂâäÈô§„Ç®„É©„Éº', 'error');
                    alert('ÂâäÈô§„Ç®„É©„Éº: ' + error.message);
                }
            }
        }

        // ========================================
        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        // ========================================

        function exportData() {
            if (businessCards.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            const dataStr = JSON.stringify(businessCards, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ÂêçÂà∫„Éá„Éº„Çø_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSyncStatus('„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂÆå‰∫Ü', 'success');
        }

        // ========================================
        // ÂêåÊúü„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        // ========================================

        let syncStatusTimeout;

        function showSyncStatus(message, type = 'syncing') {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            syncStatus.classList.remove('syncing', 'error');
            
            if (type === 'syncing') {
                syncStatus.classList.add('syncing');
            } else if (type === 'error') {
                syncStatus.classList.add('error');
            }
            
            syncText.textContent = message;
            syncStatus.style.display = 'flex';
            
            clearTimeout(syncStatusTimeout);
            
            if (type !== 'syncing') {
                syncStatusTimeout = setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>
